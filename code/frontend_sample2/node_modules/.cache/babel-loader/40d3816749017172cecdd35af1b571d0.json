{"ast":null,"code":"import { h, ref, isRef, computed, watch, provide, onBeforeUnmount, getCurrentInstance } from 'vue';\nimport QBtn from '../btn/QBtn.js';\nimport QIcon from '../icon/QIcon.js';\nimport QSpinner from '../spinner/QSpinner.js';\nimport QCircularProgress from '../circular-progress/QCircularProgress.js';\nimport useDark, { useDarkProps } from '../../composables/private/use-dark.js';\nimport useFile, { useFileProps, useFileEmits } from '../../composables/private/use-file.js';\nimport { stop } from '../../utils/event.js';\nimport { humanStorageSize } from '../../utils/format.js';\nimport { uploaderKey } from '../../utils/private/symbols.js';\n\nfunction getProgressLabel(p) {\n  return (p * 100).toFixed(2) + '%';\n}\n\nexport const coreProps = { ...useDarkProps,\n  ...useFileProps,\n  label: String,\n  color: String,\n  textColor: String,\n  square: Boolean,\n  flat: Boolean,\n  bordered: Boolean,\n  noThumbnails: Boolean,\n  autoUpload: Boolean,\n  hideUploadBtn: Boolean,\n  disable: Boolean,\n  readonly: Boolean\n};\nexport const coreEmits = [...useFileEmits, 'start', 'finish', 'added', 'removed'];\nexport function getRenderer(getPlugin) {\n  const vm = getCurrentInstance();\n  const {\n    props,\n    slots,\n    emit,\n    proxy\n  } = vm;\n  const {\n    $q\n  } = proxy;\n  const isDark = useDark(props, $q);\n\n  function updateFileStatus(file, status, uploadedSize) {\n    file.__status = status;\n\n    if (status === 'idle') {\n      file.__uploaded = 0;\n      file.__progress = 0;\n      file.__sizeLabel = humanStorageSize(file.size);\n      file.__progressLabel = '0.00%';\n      return;\n    }\n\n    if (status === 'failed') {\n      proxy.$forceUpdate();\n      return;\n    }\n\n    file.__uploaded = status === 'uploaded' ? file.size : uploadedSize;\n    file.__progress = status === 'uploaded' ? 1 : Math.min(0.9999, file.__uploaded / file.size);\n    file.__progressLabel = getProgressLabel(file.__progress);\n    proxy.$forceUpdate();\n  }\n\n  const state = {\n    files: ref([]),\n    queuedFiles: ref([]),\n    uploadedFiles: ref([]),\n    uploadedSize: ref(0),\n    updateFileStatus,\n\n    isAlive() {\n      return vm.isDeactivated !== true && vm.isUnmounted !== true;\n    }\n\n  };\n  Object.assign(state, getPlugin({\n    props,\n    slots,\n    emit,\n    helpers: state\n  }));\n  const uploadSize = ref(0);\n  const editable = computed(() => props.disable !== true && props.readonly !== true);\n\n  if (state.isBusy === void 0) {\n    state.isBusy = ref(false);\n  }\n\n  const dnd = ref(false);\n  const rootRef = ref(null);\n  const inputRef = ref(null);\n  provide(uploaderKey, renderInput);\n  const {\n    pickFiles,\n    addFiles,\n    onDragover,\n    onDragleave,\n    processFiles,\n    getDndNode,\n    maxFilesNumber,\n    maxTotalSizeNumber\n  } = useFile({\n    editable,\n    dnd,\n    getFileInput,\n    addFilesToQueue\n  });\n  const canAddFiles = computed(() => editable.value === true && state.isUploading.value !== true // if single selection and no files are queued:\n  && (props.multiple === true || state.queuedFiles.value.length === 0) // if max-files is set and current number of files does not exceeds it:\n  && (props.maxFiles === void 0 || state.files.value.length < maxFilesNumber.value) // if max-total-size is set and current upload size does not exceeds it:\n  && (props.maxTotalSize === void 0 || uploadSize.value < maxTotalSizeNumber.value));\n  const canUpload = computed(() => editable.value === true && state.isBusy.value !== true && state.isUploading.value !== true && state.queuedFiles.value.length > 0);\n  const uploadProgress = computed(() => uploadSize.value === 0 ? 0 : state.uploadedSize.value / uploadSize.value);\n  const uploadProgressLabel = computed(() => getProgressLabel(uploadProgress.value));\n  const uploadSizeLabel = computed(() => humanStorageSize(uploadSize.value));\n  const classes = computed(() => 'q-uploader column no-wrap' + (isDark.value === true ? ' q-uploader--dark q-dark' : '') + (props.bordered === true ? ' q-uploader--bordered' : '') + (props.square === true ? ' q-uploader--square no-border-radius' : '') + (props.flat === true ? ' q-uploader--flat no-shadow' : '') + (props.disable === true ? ' disabled q-uploader--disable' : ''));\n  const colorClass = computed(() => 'q-uploader__header' + (props.color !== void 0 ? ` bg-${props.color}` : '') + (props.textColor !== void 0 ? ` text-${props.textColor}` : ''));\n  watch(state.isUploading, (newVal, oldVal) => {\n    if (oldVal === false && newVal === true) {\n      emit('start');\n    } else if (oldVal === true && newVal === false) {\n      emit('finish');\n    }\n  });\n\n  function reset() {\n    if (props.disable === false) {\n      state.abort();\n      state.uploadedSize.value = 0;\n      uploadSize.value = 0;\n      revokeImgURLs();\n      state.files.value = [];\n      state.queuedFiles.value = [];\n      state.uploadedFiles.value = [];\n    }\n  }\n\n  function removeUploadedFiles() {\n    if (props.disable === false) {\n      batchRemoveFiles(['uploaded'], () => {\n        state.uploadedFiles.value = [];\n      });\n    }\n  }\n\n  function removeQueuedFiles() {\n    batchRemoveFiles(['idle', 'failed'], ({\n      size\n    }) => {\n      uploadSize.value -= size;\n      state.queuedFiles.value = [];\n    });\n  }\n\n  function batchRemoveFiles(statusList, cb) {\n    if (props.disable === true) {\n      return;\n    }\n\n    const removed = {\n      files: [],\n      size: 0\n    };\n    const localFiles = state.files.value.filter(f => {\n      if (statusList.indexOf(f.__status) === -1) {\n        return true;\n      }\n\n      removed.size += f.size;\n      removed.files.push(f);\n      f.__img !== void 0 && window.URL.revokeObjectURL(f.__img.src);\n      return false;\n    });\n\n    if (removed.files.length > 0) {\n      state.files.value = localFiles;\n      cb(removed);\n      emit('removed', removed.files);\n    }\n  }\n\n  function removeFile(file) {\n    if (props.disable) {\n      return;\n    }\n\n    if (file.__status === 'uploaded') {\n      state.uploadedFiles.value = state.uploadedFiles.value.filter(f => f.__key !== file.__key);\n    } else if (file.__status === 'uploading') {\n      file.__abort();\n    } else {\n      uploadSize.value -= file.size;\n    }\n\n    state.files.value = state.files.value.filter(f => {\n      if (f.__key !== file.__key) {\n        return true;\n      }\n\n      f.__img !== void 0 && window.URL.revokeObjectURL(f.__img.src);\n      return false;\n    });\n    state.queuedFiles.value = state.queuedFiles.value.filter(f => f.__key !== file.__key);\n    emit('removed', [file]);\n  }\n\n  function revokeImgURLs() {\n    state.files.value.forEach(f => {\n      f.__img !== void 0 && window.URL.revokeObjectURL(f.__img.src);\n    });\n  }\n\n  function getFileInput() {\n    return inputRef.value || rootRef.value.getElementsByClassName('q-uploader__input')[0];\n  }\n\n  function addFilesToQueue(e, fileList) {\n    const localFiles = processFiles(e, fileList, state.files.value, true);\n\n    if (localFiles === void 0) {\n      return;\n    }\n\n    const fileInput = getFileInput();\n\n    if (fileInput !== void 0 && fileInput !== null) {\n      fileInput.value = '';\n    }\n\n    localFiles.forEach(file => {\n      state.updateFileStatus(file, 'idle');\n      uploadSize.value += file.size;\n\n      if (props.noThumbnails !== true && file.type.toUpperCase().startsWith('IMAGE')) {\n        const img = new Image();\n        img.src = window.URL.createObjectURL(file);\n        file.__img = img;\n      }\n    });\n    state.files.value = state.files.value.concat(localFiles);\n    state.queuedFiles.value = state.queuedFiles.value.concat(localFiles);\n    emit('added', localFiles);\n    props.autoUpload === true && state.upload();\n  }\n\n  function upload() {\n    canUpload.value === true && state.upload();\n  }\n\n  function getBtn(show, icon, fn) {\n    if (show === true) {\n      const data = {\n        type: 'a',\n        key: icon,\n        icon: $q.iconSet.uploader[icon],\n        flat: true,\n        dense: true\n      };\n      let child = void 0;\n\n      if (icon === 'add') {\n        data.onClick = pickFiles;\n        child = renderInput;\n      } else {\n        data.onClick = fn;\n      }\n\n      return h(QBtn, data, child);\n    }\n  }\n\n  function renderInput() {\n    return h('input', {\n      ref: inputRef,\n      class: 'q-uploader__input overflow-hidden absolute-full',\n      tabindex: -1,\n      type: 'file',\n      title: '',\n      // try to remove default tooltip\n      accept: props.accept,\n      multiple: props.multiple === true ? 'multiple' : void 0,\n      capture: props.capture,\n      onMousedown: stop,\n      // need to stop refocus from QBtn\n      onClick: pickFiles,\n      onChange: addFilesToQueue\n    });\n  }\n\n  function getHeader() {\n    if (slots.header !== void 0) {\n      return slots.header(slotScope.value);\n    }\n\n    return [h('div', {\n      class: 'q-uploader__header-content flex flex-center no-wrap q-gutter-xs'\n    }, [getBtn(state.queuedFiles.value.length > 0, 'removeQueue', removeQueuedFiles), getBtn(state.uploadedFiles.value.length > 0, 'removeUploaded', removeUploadedFiles), state.isUploading.value === true ? h(QSpinner, {\n      class: 'q-uploader__spinner'\n    }) : null, h('div', {\n      class: 'col column justify-center'\n    }, [props.label !== void 0 ? h('div', {\n      class: 'q-uploader__title'\n    }, [props.label]) : null, h('div', {\n      class: 'q-uploader__subtitle'\n    }, [uploadSizeLabel.value + ' / ' + uploadProgressLabel.value])]), getBtn(canAddFiles.value, 'add'), getBtn(props.hideUploadBtn === false && canUpload.value === true, 'upload', state.upload), getBtn(state.isUploading.value, 'clear', state.abort)])];\n  }\n\n  function getList() {\n    if (slots.list !== void 0) {\n      return slots.list(slotScope.value);\n    }\n\n    return state.files.value.map(file => h('div', {\n      key: file.__key,\n      class: 'q-uploader__file relative-position' + (props.noThumbnails !== true && file.__img !== void 0 ? ' q-uploader__file--img' : '') + (file.__status === 'failed' ? ' q-uploader__file--failed' : file.__status === 'uploaded' ? ' q-uploader__file--uploaded' : ''),\n      style: props.noThumbnails !== true && file.__img !== void 0 ? {\n        backgroundImage: 'url(\"' + file.__img.src + '\")'\n      } : null\n    }, [h('div', {\n      class: 'q-uploader__file-header row flex-center no-wrap'\n    }, [file.__status === 'failed' ? h(QIcon, {\n      class: 'q-uploader__file-status',\n      name: $q.iconSet.type.negative,\n      color: 'negative'\n    }) : null, h('div', {\n      class: 'q-uploader__file-header-content col'\n    }, [h('div', {\n      class: 'q-uploader__title'\n    }, [file.name]), h('div', {\n      class: 'q-uploader__subtitle row items-center no-wrap'\n    }, [file.__sizeLabel + ' / ' + file.__progressLabel])]), file.__status === 'uploading' ? h(QCircularProgress, {\n      value: file.__progress,\n      min: 0,\n      max: 1,\n      indeterminate: file.__progress === 0\n    }) : h(QBtn, {\n      round: true,\n      dense: true,\n      flat: true,\n      icon: $q.iconSet.uploader[file.__status === 'uploaded' ? 'done' : 'clear'],\n      onClick: () => {\n        removeFile(file);\n      }\n    })])]));\n  }\n\n  onBeforeUnmount(() => {\n    state.isUploading.value === true && state.abort();\n    state.files.value.length > 0 && revokeImgURLs();\n  });\n  const publicMethods = {\n    pickFiles,\n    addFiles,\n    reset,\n    removeUploadedFiles,\n    removeQueuedFiles,\n    removeFile,\n    upload,\n    abort: state.abort\n  }; // TODO: the result of this computed, especially the dynamic part, isn't currently typed\n  // This result in an error with Volar when accessing the state (eg. files array)\n\n  const slotScope = computed(() => {\n    const acc = {\n      canAddFiles: canAddFiles.value,\n      canUpload: canUpload.value,\n      uploadSizeLabel: uploadSizeLabel.value,\n      uploadProgressLabel: uploadProgressLabel.value\n    };\n\n    for (const key in state) {\n      acc[key] = isRef(state[key]) === true ? state[key].value : state[key];\n    } // TODO: (Qv3) Put the QUploader instance under `ref`\n    // property for consistency and flexibility\n    // return { ref: { ...acc, ...publicMethods } }\n\n\n    return { ...acc,\n      ...publicMethods\n    };\n  }); // expose public methods\n\n  Object.assign(proxy, publicMethods);\n  return () => {\n    const children = [h('div', {\n      class: colorClass.value\n    }, getHeader()), h('div', {\n      class: 'q-uploader__list scroll'\n    }, getList()), getDndNode('uploader')];\n    state.isBusy.value === true && children.push(h('div', {\n      class: 'q-uploader__overlay absolute-full flex flex-center'\n    }, [h(QSpinner)]));\n    const data = {\n      ref: rootRef,\n      class: classes.value\n    };\n\n    if (canAddFiles.value === true) {\n      Object.assign(data, {\n        onDragover,\n        onDragleave\n      });\n    }\n\n    return h('div', data, children);\n  };\n}","map":{"version":3,"sources":["C:/Users/saina/OneDrive - City University of Hong Kong/Desktop/cityu/Cityu Year 4/FYP/code/frontend_sample2/node_modules/quasar/src/components/uploader/uploader-core.js"],"names":["h","ref","isRef","computed","watch","provide","onBeforeUnmount","getCurrentInstance","QBtn","QIcon","QSpinner","QCircularProgress","useDark","useDarkProps","useFile","useFileProps","useFileEmits","stop","humanStorageSize","uploaderKey","getProgressLabel","p","toFixed","coreProps","label","String","color","textColor","square","Boolean","flat","bordered","noThumbnails","autoUpload","hideUploadBtn","disable","readonly","coreEmits","getRenderer","getPlugin","vm","props","slots","emit","proxy","$q","isDark","updateFileStatus","file","status","uploadedSize","__status","__uploaded","__progress","__sizeLabel","size","__progressLabel","$forceUpdate","Math","min","state","files","queuedFiles","uploadedFiles","isAlive","isDeactivated","isUnmounted","Object","assign","helpers","uploadSize","editable","isBusy","dnd","rootRef","inputRef","renderInput","pickFiles","addFiles","onDragover","onDragleave","processFiles","getDndNode","maxFilesNumber","maxTotalSizeNumber","getFileInput","addFilesToQueue","canAddFiles","value","isUploading","multiple","length","maxFiles","maxTotalSize","canUpload","uploadProgress","uploadProgressLabel","uploadSizeLabel","classes","colorClass","newVal","oldVal","reset","abort","revokeImgURLs","removeUploadedFiles","batchRemoveFiles","removeQueuedFiles","statusList","cb","removed","localFiles","filter","f","indexOf","push","__img","window","URL","revokeObjectURL","src","removeFile","__key","__abort","forEach","getElementsByClassName","e","fileList","fileInput","type","toUpperCase","startsWith","img","Image","createObjectURL","concat","upload","getBtn","show","icon","fn","data","key","iconSet","uploader","dense","child","onClick","class","tabindex","title","accept","capture","onMousedown","onChange","getHeader","header","slotScope","getList","list","map","style","backgroundImage","name","negative","max","indeterminate","round","publicMethods","acc","children"],"mappings":"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","sourcesContent":["import { h, ref, isRef, computed, watch, provide, onBeforeUnmount, getCurrentInstance } from 'vue'\n\nimport QBtn from '../btn/QBtn.js'\nimport QIcon from '../icon/QIcon.js'\nimport QSpinner from '../spinner/QSpinner.js'\nimport QCircularProgress from '../circular-progress/QCircularProgress.js'\n\nimport useDark, { useDarkProps } from '../../composables/private/use-dark.js'\nimport useFile, { useFileProps, useFileEmits } from '../../composables/private/use-file.js'\n\nimport { stop } from '../../utils/event.js'\nimport { humanStorageSize } from '../../utils/format.js'\nimport { uploaderKey } from '../../utils/private/symbols.js'\n\nfunction getProgressLabel (p) {\n  return (p * 100).toFixed(2) + '%'\n}\n\nexport const coreProps = {\n  ...useDarkProps,\n  ...useFileProps,\n\n  label: String,\n\n  color: String,\n  textColor: String,\n\n  square: Boolean,\n  flat: Boolean,\n  bordered: Boolean,\n\n  noThumbnails: Boolean,\n  autoUpload: Boolean,\n  hideUploadBtn: Boolean,\n\n  disable: Boolean,\n  readonly: Boolean\n}\n\nexport const coreEmits = [\n  ...useFileEmits,\n  'start', 'finish', 'added', 'removed'\n]\n\nexport function getRenderer (getPlugin) {\n  const vm = getCurrentInstance()\n  const { props, slots, emit, proxy } = vm\n  const { $q } = proxy\n\n  const isDark = useDark(props, $q)\n\n  function updateFileStatus (file, status, uploadedSize) {\n    file.__status = status\n\n    if (status === 'idle') {\n      file.__uploaded = 0\n      file.__progress = 0\n      file.__sizeLabel = humanStorageSize(file.size)\n      file.__progressLabel = '0.00%'\n      return\n    }\n    if (status === 'failed') {\n      proxy.$forceUpdate()\n      return\n    }\n\n    file.__uploaded = status === 'uploaded'\n      ? file.size\n      : uploadedSize\n\n    file.__progress = status === 'uploaded'\n      ? 1\n      : Math.min(0.9999, file.__uploaded / file.size)\n\n    file.__progressLabel = getProgressLabel(file.__progress)\n    proxy.$forceUpdate()\n  }\n\n  const state = {\n    files: ref([]),\n    queuedFiles: ref([]),\n    uploadedFiles: ref([]),\n    uploadedSize: ref(0),\n\n    updateFileStatus,\n    isAlive () {\n      return vm.isDeactivated !== true && vm.isUnmounted !== true\n    }\n  }\n\n  Object.assign(state, getPlugin({ props, slots, emit, helpers: state }))\n\n  const uploadSize = ref(0)\n  const editable = computed(() => props.disable !== true && props.readonly !== true)\n\n  if (state.isBusy === void 0) {\n    state.isBusy = ref(false)\n  }\n\n  const dnd = ref(false)\n\n  const rootRef = ref(null)\n  const inputRef = ref(null)\n\n  provide(uploaderKey, renderInput)\n\n  const {\n    pickFiles,\n    addFiles,\n    onDragover,\n    onDragleave,\n    processFiles,\n    getDndNode,\n    maxFilesNumber,\n    maxTotalSizeNumber\n  } = useFile({ editable, dnd, getFileInput, addFilesToQueue })\n\n  const canAddFiles = computed(() =>\n    editable.value === true\n    && state.isUploading.value !== true\n    // if single selection and no files are queued:\n    && (props.multiple === true || state.queuedFiles.value.length === 0)\n    // if max-files is set and current number of files does not exceeds it:\n    && (props.maxFiles === void 0 || state.files.value.length < maxFilesNumber.value)\n    // if max-total-size is set and current upload size does not exceeds it:\n    && (props.maxTotalSize === void 0 || uploadSize.value < maxTotalSizeNumber.value)\n  )\n\n  const canUpload = computed(() =>\n    editable.value === true\n    && state.isBusy.value !== true\n    && state.isUploading.value !== true\n    && state.queuedFiles.value.length > 0\n  )\n\n  const uploadProgress = computed(() => (\n    uploadSize.value === 0\n      ? 0\n      : state.uploadedSize.value / uploadSize.value\n  ))\n\n  const uploadProgressLabel = computed(() => getProgressLabel(uploadProgress.value))\n  const uploadSizeLabel = computed(() => humanStorageSize(uploadSize.value))\n\n  const classes = computed(() =>\n    'q-uploader column no-wrap'\n    + (isDark.value === true ? ' q-uploader--dark q-dark' : '')\n    + (props.bordered === true ? ' q-uploader--bordered' : '')\n    + (props.square === true ? ' q-uploader--square no-border-radius' : '')\n    + (props.flat === true ? ' q-uploader--flat no-shadow' : '')\n    + (props.disable === true ? ' disabled q-uploader--disable' : '')\n  )\n\n  const colorClass = computed(() =>\n    'q-uploader__header'\n    + (props.color !== void 0 ? ` bg-${ props.color }` : '')\n    + (props.textColor !== void 0 ? ` text-${ props.textColor }` : '')\n  )\n\n  watch(state.isUploading, (newVal, oldVal) => {\n    if (oldVal === false && newVal === true) {\n      emit('start')\n    }\n    else if (oldVal === true && newVal === false) {\n      emit('finish')\n    }\n  })\n\n  function reset () {\n    if (props.disable === false) {\n      state.abort()\n      state.uploadedSize.value = 0\n      uploadSize.value = 0\n      revokeImgURLs()\n      state.files.value = []\n      state.queuedFiles.value = []\n      state.uploadedFiles.value = []\n    }\n  }\n\n  function removeUploadedFiles () {\n    if (props.disable === false) {\n      batchRemoveFiles([ 'uploaded' ], () => {\n        state.uploadedFiles.value = []\n      })\n    }\n  }\n\n  function removeQueuedFiles () {\n    batchRemoveFiles([ 'idle', 'failed' ], ({ size }) => {\n      uploadSize.value -= size\n      state.queuedFiles.value = []\n    })\n  }\n\n  function batchRemoveFiles (statusList, cb) {\n    if (props.disable === true) {\n      return\n    }\n\n    const removed = {\n      files: [],\n      size: 0\n    }\n\n    const localFiles = state.files.value.filter(f => {\n      if (statusList.indexOf(f.__status) === -1) {\n        return true\n      }\n\n      removed.size += f.size\n      removed.files.push(f)\n\n      f.__img !== void 0 && window.URL.revokeObjectURL(f.__img.src)\n\n      return false\n    })\n\n    if (removed.files.length > 0) {\n      state.files.value = localFiles\n      cb(removed)\n      emit('removed', removed.files)\n    }\n  }\n\n  function removeFile (file) {\n    if (props.disable) { return }\n\n    if (file.__status === 'uploaded') {\n      state.uploadedFiles.value = state.uploadedFiles.value.filter(f => f.__key !== file.__key)\n    }\n    else if (file.__status === 'uploading') {\n      file.__abort()\n    }\n    else {\n      uploadSize.value -= file.size\n    }\n\n    state.files.value = state.files.value.filter(f => {\n      if (f.__key !== file.__key) {\n        return true\n      }\n\n      f.__img !== void 0 && window.URL.revokeObjectURL(f.__img.src)\n\n      return false\n    })\n\n    state.queuedFiles.value = state.queuedFiles.value.filter(f => f.__key !== file.__key)\n    emit('removed', [ file ])\n  }\n\n  function revokeImgURLs () {\n    state.files.value.forEach(f => {\n      f.__img !== void 0 && window.URL.revokeObjectURL(f.__img.src)\n    })\n  }\n\n  function getFileInput () {\n    return inputRef.value\n      || rootRef.value.getElementsByClassName('q-uploader__input')[ 0 ]\n  }\n\n  function addFilesToQueue (e, fileList) {\n    const localFiles = processFiles(e, fileList, state.files.value, true)\n\n    if (localFiles === void 0) { return }\n\n    const fileInput = getFileInput()\n    if (fileInput !== void 0 && fileInput !== null) {\n      fileInput.value = ''\n    }\n\n    localFiles.forEach(file => {\n      state.updateFileStatus(file, 'idle')\n      uploadSize.value += file.size\n\n      if (props.noThumbnails !== true && file.type.toUpperCase().startsWith('IMAGE')) {\n        const img = new Image()\n        img.src = window.URL.createObjectURL(file)\n        file.__img = img\n      }\n    })\n\n    state.files.value = state.files.value.concat(localFiles)\n    state.queuedFiles.value = state.queuedFiles.value.concat(localFiles)\n    emit('added', localFiles)\n    props.autoUpload === true && state.upload()\n  }\n\n  function upload () {\n    canUpload.value === true && state.upload()\n  }\n\n  function getBtn (show, icon, fn) {\n    if (show === true) {\n      const data = {\n        type: 'a',\n        key: icon,\n        icon: $q.iconSet.uploader[ icon ],\n        flat: true,\n        dense: true\n      }\n\n      let child = void 0\n\n      if (icon === 'add') {\n        data.onClick = pickFiles\n        child = renderInput\n      }\n      else {\n        data.onClick = fn\n      }\n\n      return h(QBtn, data, child)\n    }\n  }\n\n  function renderInput () {\n    return h('input', {\n      ref: inputRef,\n      class: 'q-uploader__input overflow-hidden absolute-full',\n      tabindex: -1,\n      type: 'file',\n      title: '', // try to remove default tooltip\n      accept: props.accept,\n      multiple: props.multiple === true ? 'multiple' : void 0,\n      capture: props.capture,\n      onMousedown: stop, // need to stop refocus from QBtn\n      onClick: pickFiles,\n      onChange: addFilesToQueue\n    })\n  }\n\n  function getHeader () {\n    if (slots.header !== void 0) {\n      return slots.header(slotScope.value)\n    }\n\n    return [\n      h('div', {\n        class: 'q-uploader__header-content flex flex-center no-wrap q-gutter-xs'\n      }, [\n        getBtn(state.queuedFiles.value.length > 0, 'removeQueue', removeQueuedFiles),\n        getBtn(state.uploadedFiles.value.length > 0, 'removeUploaded', removeUploadedFiles),\n\n        state.isUploading.value === true\n          ? h(QSpinner, { class: 'q-uploader__spinner' })\n          : null,\n\n        h('div', { class: 'col column justify-center' }, [\n          props.label !== void 0\n            ? h('div', { class: 'q-uploader__title' }, [ props.label ])\n            : null,\n\n          h('div', { class: 'q-uploader__subtitle' }, [\n            uploadSizeLabel.value + ' / ' + uploadProgressLabel.value\n          ])\n        ]),\n\n        getBtn(canAddFiles.value, 'add'),\n        getBtn(props.hideUploadBtn === false && canUpload.value === true, 'upload', state.upload),\n        getBtn(state.isUploading.value, 'clear', state.abort)\n      ])\n    ]\n  }\n\n  function getList () {\n    if (slots.list !== void 0) {\n      return slots.list(slotScope.value)\n    }\n\n    return state.files.value.map(file => h('div', {\n      key: file.__key,\n      class: 'q-uploader__file relative-position'\n        + (props.noThumbnails !== true && file.__img !== void 0 ? ' q-uploader__file--img' : '')\n        + (\n          file.__status === 'failed'\n            ? ' q-uploader__file--failed'\n            : (file.__status === 'uploaded' ? ' q-uploader__file--uploaded' : '')\n        ),\n      style: props.noThumbnails !== true && file.__img !== void 0\n        ? { backgroundImage: 'url(\"' + file.__img.src + '\")' }\n        : null\n    }, [\n      h('div', {\n        class: 'q-uploader__file-header row flex-center no-wrap'\n      }, [\n        file.__status === 'failed'\n          ? h(QIcon, {\n            class: 'q-uploader__file-status',\n            name: $q.iconSet.type.negative,\n            color: 'negative'\n          })\n          : null,\n\n        h('div', { class: 'q-uploader__file-header-content col' }, [\n          h('div', { class: 'q-uploader__title' }, [ file.name ]),\n          h('div', {\n            class: 'q-uploader__subtitle row items-center no-wrap'\n          }, [\n            file.__sizeLabel + ' / ' + file.__progressLabel\n          ])\n        ]),\n\n        file.__status === 'uploading'\n          ? h(QCircularProgress, {\n            value: file.__progress,\n            min: 0,\n            max: 1,\n            indeterminate: file.__progress === 0\n          })\n          : h(QBtn, {\n            round: true,\n            dense: true,\n            flat: true,\n            icon: $q.iconSet.uploader[ file.__status === 'uploaded' ? 'done' : 'clear' ],\n            onClick: () => { removeFile(file) }\n          })\n      ])\n    ]))\n  }\n\n  onBeforeUnmount(() => {\n    state.isUploading.value === true && state.abort()\n    state.files.value.length > 0 && revokeImgURLs()\n  })\n\n  const publicMethods = {\n    pickFiles,\n    addFiles,\n    reset,\n    removeUploadedFiles,\n    removeQueuedFiles,\n    removeFile,\n    upload,\n    abort: state.abort\n  }\n\n  // TODO: the result of this computed, especially the dynamic part, isn't currently typed\n  // This result in an error with Volar when accessing the state (eg. files array)\n  const slotScope = computed(() => {\n    const acc = {\n      canAddFiles: canAddFiles.value,\n      canUpload: canUpload.value,\n      uploadSizeLabel: uploadSizeLabel.value,\n      uploadProgressLabel: uploadProgressLabel.value\n    }\n\n    for (const key in state) {\n      acc[ key ] = isRef(state[ key ]) === true\n        ? state[ key ].value\n        : state[ key ]\n    }\n\n    // TODO: (Qv3) Put the QUploader instance under `ref`\n    // property for consistency and flexibility\n    // return { ref: { ...acc, ...publicMethods } }\n    return { ...acc, ...publicMethods }\n  })\n\n  // expose public methods\n  Object.assign(proxy, publicMethods)\n\n  return () => {\n    const children = [\n      h('div', { class: colorClass.value }, getHeader()),\n      h('div', { class: 'q-uploader__list scroll' }, getList()),\n      getDndNode('uploader')\n    ]\n\n    state.isBusy.value === true && children.push(\n      h('div', {\n        class: 'q-uploader__overlay absolute-full flex flex-center'\n      }, [ h(QSpinner) ])\n    )\n\n    const data = { ref: rootRef, class: classes.value }\n\n    if (canAddFiles.value === true) {\n      Object.assign(data, { onDragover, onDragleave })\n    }\n\n    return h('div', data, children)\n  }\n}\n"]},"metadata":{},"sourceType":"module"}